name: AI-Powered Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]
  issue_comment:
    types: [created]
  schedule:
    - cron: '0 9 * * 1'  # Weekly comprehensive review on Mondays at 9 AM

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  ai-review:
    if: github.event_name == 'pull_request' || (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write
      issues: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run security validation
        run: npm run lint:security
        continue-on-error: true
        
      - name: Run architecture validation
        run: npm run lint:architecture
        continue-on-error: true
        
      - name: Run performance validation
        run: npm run lint:performance
        continue-on-error: true
        
      - name: AI-Powered Code Review
        run: |
          echo "AI-Powered Code Review Analysis"
          echo "================================"
          echo "ğŸ” Analyzing changes for:"
          echo "  - Architecture compliance"
          echo "  - Security best practices"
          echo "  - Performance optimization"
          echo "  - Code maintainability"
          echo "  - Documentation quality"
          echo ""
          echo "ğŸ“Š Validation Results Summary:"
          echo "  - Security: $(npm run lint:security > /dev/null 2>&1 && echo 'âœ… Passed' || echo 'âš ï¸ Warnings')"
          echo "  - Architecture: $(npm run lint:architecture > /dev/null 2>&1 && echo 'âœ… Passed' || echo 'âŒ Failed')"
          echo "  - Performance: $(npm run lint:performance > /dev/null 2>&1 && echo 'âœ… Passed' || echo 'âš ï¸ Warnings')"
          echo ""
          echo "For detailed AI-powered analysis, use custom commands:"
          echo "  - /architecture-review - Comprehensive architecture analysis" 
          echo "  - /security-scan - Security vulnerability assessment"
          echo "  - /performance-check - Performance optimization review"
          echo "  - /documentation-audit - Documentation quality review"
          echo "  - /quick-fix - Immediate actionable fixes"
          
      - name: Custom Command Detection
        if: github.event_name == 'issue_comment'
        run: |
          COMMENT_BODY="${{ github.event.comment.body }}"
          
          if echo "$COMMENT_BODY" | grep -q "/architecture-review"; then
            echo "CUSTOM_COMMAND=architecture-review" >> $GITHUB_ENV
          elif echo "$COMMENT_BODY" | grep -q "/security-scan"; then
            echo "CUSTOM_COMMAND=security-scan" >> $GITHUB_ENV
          elif echo "$COMMENT_BODY" | grep -q "/performance-check"; then
            echo "CUSTOM_COMMAND=performance-check" >> $GITHUB_ENV
          elif echo "$COMMENT_BODY" | grep -q "/documentation-audit"; then
            echo "CUSTOM_COMMAND=documentation-audit" >> $GITHUB_ENV
          elif echo "$COMMENT_BODY" | grep -q "/quick-fix"; then
            echo "CUSTOM_COMMAND=quick-fix" >> $GITHUB_ENV
          fi
          
      - name: Execute Custom Command
        if: env.CUSTOM_COMMAND != ''
        run: |
          if [ -f ".claude/commands/${CUSTOM_COMMAND}.md" ]; then
            echo "Executing custom command: $CUSTOM_COMMAND"
            cat .claude/commands/${CUSTOM_COMMAND}.md
          fi

  comprehensive-audit:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      issues: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run comprehensive validation
        run: npm run validate:all
        
      - name: Weekly Architecture Audit
        run: |
          echo "ğŸ“… Weekly Architecture and Security Audit - $(date '+%Y-%m-%d')"
          echo "=============================================="
          echo ""
          echo "ğŸ—ï¸ Architecture Evolution Assessment:"
          npm run lint:architecture || echo "âš ï¸ Architecture issues detected"
          echo ""
          echo "ğŸ”’ Security Posture Review:"
          npm run lint:security || echo "âš ï¸ Security issues detected"
          echo ""
          echo "âš¡ Performance Trends Analysis:"
          npm run lint:performance || echo "âš ï¸ Performance issues detected"
          echo ""
          echo "ğŸ“– Documentation Currency Check:"
          npm run docs:validate-structure || echo "âš ï¸ Documentation issues detected"
          echo ""
          echo "âœ… Comprehensive audit completed"
          echo "ğŸ’¡ For detailed analysis, run individual validation commands or use AI agent custom commands"
